<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChainStamp - On-Chain Notary</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.1/ethers.umd.min.js"></script>

    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <!-- Dark mode config -->
    <script>
        tailwind.config = { darkMode: "class" };

        if (
            localStorage.theme === "dark" ||
            (!("theme" in localStorage) &&
                window.matchMedia("(prefers-color-scheme: dark)").matches)
        ) {
            document.documentElement.classList.add("dark");
        } else {
            document.documentElement.classList.remove("dark");
        }
    </script>

    <style>
        input[type="file"]::file-selector-button {
            @apply bg-indigo-600 text-white font-semibold rounded-lg p-2.5 px-4 cursor-pointer
            hover:bg-indigo-500 transition-all duration-200
            dark:bg-indigo-700 dark:hover:bg-indigo-600;
        }
    </style>
</head>

<body
    class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen font-sans p-8 transition-colors duration-300"
>
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="mb-10 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <svg
                    class="h-12 w-12 text-indigo-600 dark:text-indigo-400"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                    />
                </svg>
                <h1 class="text-4xl md:text-5xl font-bold">ChainStamp</h1>
            </div>

            <!-- Dark mode toggle -->
            <button
                id="darkModeToggle"
                class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300
                hover:bg-gray-300 dark:hover:bg-gray-600 transition-all"
            >
                <svg
                    id="sunIcon"
                    class="h-6 w-6 dark:hidden"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386
                        6.364-1.591-1.591M12 18.75V21m-6.364-.386 1.591-1.591M3
                        12H.75m.386-6.364 1.591 1.591"
                    />
                </svg>

                <svg
                    id="moonIcon"
                    class="h-6 w-6 hidden dark:block"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M21.752 15.002A9.72 9.72 0 0 1 18
                        15.75 9.75 9.75 0 0 1 8.25 6c0-1.73.465-3.32
                        1.252-4.754A9.753 9.753 0 0 0 3 11.25a9.75
                        9.75 0 0 0 9.75 9.75 9.753 9.753 0 0 0
                        9.002-5.998Z"
                    />
                </svg>
            </button>
        </header>

        <!-- Connect wallet -->
        <div class="text-center mb-8">
            <button
                id="connectButton"
                class="bg-indigo-600 text-white font-semibold rounded-lg py-3 px-6 text-lg
                hover:bg-indigo-500 dark:bg-indigo-700 dark:hover:bg-indigo-600
                transition-all shadow-lg"
            >
                Connect Wallet
            </button>
        </div>

        <div
            id="statusMessage"
            class="text-center text-lg p-4 mb-8 rounded-lg hidden"
        ></div>

        <!-- Main -->
        <div class="grid md:grid-cols-2 gap-8">
            <!-- Notarize -->
            <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl">
                <h2 class="text-3xl font-semibold mb-6">1. Notarize a File</h2>

                <p class="text-gray-600 dark:text-gray-300 mb-6">
                    Select a file to calculate its unique hash and store it on
                    the blockchain.
                    <strong class="text-indigo-600 dark:text-indigo-400">The file never leaves your device.</strong>
                </p>

                <input type="file" id="fileNotarize" class="block w-full mb-6" />

                <button
                    id="notarizeButton"
                    class="w-full bg-blue-600 text-white font-semibold rounded-lg py-3 px-6 text-lg
                    hover:bg-blue-500 dark:bg-blue-700 dark:hover:bg-blue-600
                    flex items-center justify-center space-x-2"
                    disabled
                >
                    <svg
                        id="notarizeSpinner"
                        class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden"
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                    >
                        <circle
                            class="opacity-25"
                            cx="12"
                            cy="12"
                            r="10"
                            stroke="currentColor"
                            stroke-width="4"
                        ></circle>
                        <path
                            class="opacity-75"
                            fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373
                            0 12h4zm2 5.291A7.962 7.962 0 014
                            12H0c0 3.042 1.135 5.824 3
                            7.938l3-2.647z"
                        ></path>
                    </svg>
                    <span id="notarizeButtonText">Notarize File</span>
                </button>
            </div>

            <!-- Verify -->
            <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl">
                <h2 class="text-3xl font-semibold mb-6">2. Verify a File</h2>

                <p class="text-gray-600 dark:text-gray-300 mb-6">
                    Upload a file to check if it has already been notarized.
                </p>

                <input type="file" id="fileVerify" class="block w-full mb-6" />

                <button
                    id="verifyButton"
                    class="w-full bg-gray-600 text-white font-semibold rounded-lg py-3 px-6 text-lg
                    hover:bg-gray-500 dark:bg-gray-700 dark:hover:bg-gray-600"
                    disabled
                >
                    Verify File
                </button>

                <div
                    id="verifyResult"
                    class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg mt-4 hidden text-sm"
                ></div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 text-center text-gray-500 dark:text-gray-400">
            <p>A DApp by Zaira Anwar</p>
            <div class="flex justify-center space-x-4 mt-2">
                <a
                    href="https://linkedin.com/in/your-profile"
                    target="_blank"
                    class="hover:text-indigo-500"
                    >LinkedIn</a
                >
                <span>&bull;</span>
                <a
                    href="https://github.com/your-username"
                    target="_blank"
                    class="hover:text-indigo-500"
                    >GitHub</a
                >
            </div>
        </footer>
    </div>

    <!-- SCRIPT -->
    <script>
        const CONTRACT_ADDRESS =
            "0x05152EaF4115DdE7815BBdCFa08c4e21f6b2DB83";

        const CONTRACT_ABI = [
            {
                anonymous: false,
                inputs: [
                    { indexed: true, internalType: "address", name: "owner", type: "address" },
                    { indexed: true, internalType: "bytes32", name: "fileHash", type: "bytes32" },
                    { indexed: false, internalType: "uint256", name: "timestamp", type: "uint256" }
                ],
                name: "FileNotarized",
                type: "event"
            },
            {
                inputs: [{ internalType: "bytes32", name: "", type: "bytes32" }],
                name: "proofs",
                outputs: [
                    { internalType: "address", name: "owner", type: "address" },
                    { internalType: "uint256", name: "timestamp", type: "uint256" }
                ],
                stateMutability: "view",
                type: "function",
                constant: true
            },
            {
                inputs: [{ internalType: "bytes32", name: "_fileHash", type: "bytes32" }],
                name: "notarize",
                outputs: [],
                stateMutability: "nonpayable",
                type: "function"
            },
            {
                inputs: [{ internalType: "bytes32", name: "_fileHash", type: "bytes32" }],
                name: "verify",
                outputs: [
                    { internalType: "address", name: "owner", type: "address" },
                    { internalType: "uint256", name: "timestamp", type: "uint256" }
                ],
                stateMutability: "view",
                type: "function",
                constant: true
            }
        ];

        let provider, signer, contract;

        const connectButton = document.getElementById("connectButton");
        const notarizeButton = document.getElementById("notarizeButton");
        const verifyButton = document.getElementById("verifyButton");
        const fileNotarizeInput = document.getElementById("fileNotarize");
        const fileVerifyInput = document.getElementById("fileVerify");
        const statusMessage = document.getElementById("statusMessage");
        const verifyResult = document.getElementById("verifyResult");
        const darkModeToggle = document.getElementById("darkModeToggle");
        const notarizeSpinner = document.getElementById("notarizeSpinner");
        const notarizeButtonText = document.getElementById("notarizeButtonText");

        connectButton.onclick = connectWallet;
        notarizeButton.onclick = notarizeFile;
        verifyButton.onclick = verifyFile;
        darkModeToggle.onclick = toggleDarkMode;

        async function connectWallet() {
            if (!window.ethereum) {
                showStatus("Error: MetaMask not installed!", true);
                return;
            }

            try {
                await window.ethereum.request({ method: "eth_requestAccounts" });

                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                const address = await signer.getAddress();
                connectButton.textContent =
                    "Connected: " +
                    address.substring(0, 6) +
                    "..." +
                    address.substring(address.length - 4);

                connectButton.disabled = true;
                notarizeButton.disabled = false;
                verifyButton.disabled = false;

                showStatus("Wallet connected!", false);
            } catch (err) {
                showStatus("Wallet connection failed.", true);
            }
        }

        async function notarizeFile() {
            const file = fileNotarizeInput.files[0];
            if (!file) return showStatus("Select a file first.", true);

            notarizeButton.disabled = true;
            notarizeSpinner.classList.remove("hidden");
            notarizeButtonText.textContent = "Hashing file...";

            try {
                const fileHash = await calculateFileHash(file);

                notarizeButtonText.textContent = "Confirm in MetaMask...";
                const tx = await contract.notarize(fileHash);

                notarizeButtonText.textContent = "Confirming...";
                await tx.wait();

                showStatus("File notarized successfully!", false);

                confetti({
                    particleCount: 150,
                    spread: 80,
                    origin: { y: 0.6 }
                });
            } catch (err) {
                showStatus("Error notarizing file.", true);
            } finally {
                setTimeout(() => {
                    notarizeSpinner.classList.add("hidden");
                    notarizeButtonText.textContent = "Notarize File";
                    notarizeButton.disabled = false;
                }, 1200);
            }
        }

        async function verifyFile() {
            const file = fileVerifyInput.files[0];
            if (!file) return showStatus("Select a file first.", true);

            verifyButton.disabled = true;
            verifyButton.textContent = "Verifying...";

            try {
                const fileHash = await calculateFileHash(file);
                const [owner, timestamp] = await contract.verify(fileHash);

                if (timestamp === 0n) {
                    verifyResult.innerHTML = `
                        <p class="font-bold text-red-500">Not Found</p>
                        <p>This file hash does not exist on-chain.</p>`;
                } else {
                    const date = new Date(Number(timestamp) * 1000).toLocaleString();
                    verifyResult.innerHTML = `
                        <p class="font-bold text-green-500">Verified</p>
                        <p><strong>Owner:</strong> ${owner}</p>
                        <p><strong>Timestamp:</strong> ${date}</p>`;
                }
                verifyResult.classList.remove("hidden");
                showStatus("Verification complete.", false);
            } catch (err) {
                showStatus("Verification failed.", true);
            } finally {
                verifyButton.textContent = "Verify File";
                verifyButton.disabled = false;
            }
        }

        async function calculateFileHash(file) {
            const buffer = await file.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return (
                "0x" +
                hashArray.map((b) => b.toString(16).padStart(2, "0")).join("")
            );
        }

        function toggleDarkMode() {
            if (document.documentElement.classList.contains("dark")) {
                document.documentElement.classList.remove("dark");
                localStorage.theme = "light";
            } else {
                document.documentElement.classList.add("dark");
                localStorage.theme = "dark";
            }
        }

        function showStatus(message, err = false) {
            statusMessage.textContent = message;
            statusMessage.classList.remove("hidden");

            statusMessage.className =
                "text-center text-lg p-4 mb-8 rounded-lg " +
                (err
                    ? "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"
                    : "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200");
        }
    </script>
</body>
</html>
